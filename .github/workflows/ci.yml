name: CI

on:
    push:
        branches: ["main"]
    pull_request:
        branches: ["main"]

jobs:
    # Python linting and formatting check
    python-lint:
        name: Python Linting & Formatting
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.12"

            - name: Install uv
              uses: astral-sh/setup-uv@v5
              with:
                  enable-cache: true

            - name: Install dependencies
              run: |
                  uv sync --group pre-commit

            - name: Check formatting with black
              run: |
                  uv run black --check src/ tests/

            - name: Check import sorting with isort
              run: |
                  uv run isort --check-only --profile black src/ tests/

            - name: Lint with flake8
              run: |
                  uv run flake8 src/ tests/ --count --select=E9,F63,F7,F82 --show-source --statistics
                  uv run flake8 src/ tests/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

    # Dart/Flutter linting and formatting check
    dart-lint:
        name: Dart Linting & Formatting
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Set up Flutter
              uses: subosito/flutter-action@v2
              with:
                  flutter-version: "3.27.x"
                  channel: "stable"

            - name: Install dependencies
              run: |
                  cd src/flutter/flet_secure_storage
                  flutter pub get

            - name: Check Dart formatting
              run: |
                  cd src/flutter/flet_secure_storage
                  dart format --set-exit-if-changed .

            - name: Analyze Dart code
              run: |
                  cd src/flutter/flet_secure_storage
                  dart analyze --fatal-infos

    # Python tests on multiple versions
    python-test:
        name: Python Tests (Python ${{ matrix.python-version }})
        runs-on: ${{ matrix.os }}
        strategy:
            fail-fast: false
            matrix:
                os: [ubuntu-latest, windows-latest, macos-latest]
                python-version: ["3.10", "3.11", "3.12", "3.13"]

        steps:
            - uses: actions/checkout@v4

            - name: Set up Python ${{ matrix.python-version }}
              uses: actions/setup-python@v5
              with:
                  python-version: ${{ matrix.python-version }}

            - name: Install uv
              uses: astral-sh/setup-uv@v5
              with:
                  enable-cache: true

            - name: Install dependencies
              run: |
                  uv sync --group testing

            - name: Run tests with pytest
              run: |
                  uv run pytest -v --tb=short

    # Type checking (optional but recommended)
    type-check:
        name: Python Type Checking
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.12"

            - name: Install uv
              uses: astral-sh/setup-uv@v5
              with:
                  enable-cache: true

            - name: Install dependencies
              run: |
                  uv sync --group typing

            - name: Run mypy
              run: |
                  uv run mypy src/ --ignore-missing-imports || echo "Type checking found issues (non-blocking)"
